#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <time.h>


#include <iostream>
#include <string>
#include <sstream>
#include "Helpers.h"
using namespace std;



// This autogenerated skeleton file illustrates how to build a server.
// You should copy it to another filename to avoid overwriting it.

#include "velasscoThrift.h"
#include <thrift/protocol/TBinaryProtocol.h>
#include <thrift/server/TSimpleServer.h>
#include <thrift/transport/TServerSocket.h>
#include <thrift/transport/TBufferTransports.h>
#include <thrift/concurrency/ThreadManager.h>
#include <thrift/concurrency/PosixThreadFactory.h>
#include <thrift/protocol/TBinaryProtocol.h>
#include <thrift/server/TSimpleServer.h>
#include <thrift/server/TThreadPoolServer.h>
#include <thrift/server/TThreadedServer.h>
#include <thrift/transport/TServerSocket.h>
#include <thrift/transport/TTransportUtils.h>
#include <thrift/TToString.h>

using namespace apache::thrift;
using namespace apache::thrift::concurrency;
using namespace apache::thrift::protocol;
using namespace apache::thrift::transport;
using namespace apache::thrift::server;

using boost::shared_ptr;


#include "storageModule.h"

bool askForHelp( const char *txt) {
  return !strcasecmp( txt, "-h") || !strcasecmp( txt, "--h") || !strcasecmp( txt, "-help") || !strcasecmp( txt, "--help");
}

using namespace std;
int main(int argc, char **argv)
{
    
    srand(time(NULL));
    
    int listen_port = 26266;
    if ( argc == 2) {
      if ( askForHelp( argv[ 1])) {
	printf( "Usage: %s [ port (default %d)]\n", argv[ 0], listen_port);
	return EXIT_FAILURE;
      }
      int new_port = listen_port;
      int n = sscanf( argv[ 1], "%d", &new_port);
      if ( n == 1) // sscanf ok
	listen_port = new_port;
    }
    
    const int workerCount = 64;
    
    boost::shared_ptr<VELaSSCoHandler> handler(new VELaSSCoHandler());
    boost::shared_ptr<TProcessor> processor(new VELaSSCoProcessor(handler));
    boost::shared_ptr<TServerTransport> serverTransport(new TServerSocket(listen_port));
    boost::shared_ptr<TTransportFactory> transportFactory(new TBufferedTransportFactory());
    boost::shared_ptr<TProtocolFactory> protocolFactory(new TBinaryProtocolFactory());
    
    
    //TSimpleServer server(processor, serverTransport, transportFactory, protocolFactory);
    
    boost::shared_ptr<ThreadManager> threadManager = ThreadManager::newSimpleThreadManager(workerCount);
    boost::shared_ptr<PosixThreadFactory> threadFactory = boost::shared_ptr<PosixThreadFactory>(new PosixThreadFactory());
    threadManager->threadFactory(threadFactory);
    threadManager->start();
    
    TThreadedServer server(processor,
                           serverTransport,
                           transportFactory,
                           protocolFactory);
    
    DEBUG( "listening on port " << listen_port);

    server.serve();
    return 0;
}

